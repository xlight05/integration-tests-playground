name: BCentral Integration tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run the tests'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - stage
        - prod
  schedule:
    - cron:  '0 6 * * *'

jobs:
  dev-setup:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'dev' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
      - name: Setup environments
        id: write
        run: |
          cd tests/integration_tests/test_packages
          tests=$(ls -d */ | cut -f1 -d'/' | jq -R -s -c 'split("\n")[:-1]')
          echo "::set-output name=test::${tests}"
    outputs:
      matrix: ${{ steps.write.outputs.test }}
  dev-push:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'dev' }}
    needs: dev-setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_name: ${{ fromJson(needs.dev-setup.outputs.matrix) }}
    env:
      TEST_NAME: "${{ matrix.test_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
      - name: Build Package
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_packages/${{ matrix.test_name }}
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_DEV_ACCESS_TOKEN }}
          BALLERINA_DEV_CENTRAL: true
        with:
          args:
            pack
      - name: Push Package
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_packages/${{ matrix.test_name }}
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_DEV_ACCESS_TOKEN }}
          BALLERINA_DEV_CENTRAL: true
        with:
          args:
            push
  dev-test:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'dev' }}
    needs: dev-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
      - name: Execute tests
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_suite
          BALLERINA_DEV_CENTRAL: true
          API_URL : https://api.dev-central.ballerina.io
          DOCS_URL : https://dev-central.ballerina.io
        with:
          args:
            test
  dev-cleanup:
    if: ${{ github.event_name == 'schedule' || (github.event.inputs.environment == 'dev' && always()) }}
    needs: [dev-push,dev-test]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: dev
    - name: Cleanup Packages
      shell: bash
      run: |
        pushd tests/integration_tests/test_packages
          
        for d in */ ; do
          pushd $d
          connectorName="$d"
          curl -X POST -H "Accept: application/vnd.github.v3+json"  -H "authorization: Bearer ${{ secrets.PAT_TOKEN }}" 'https://api.github.com/repos/wso2-enterprise/ballerina-registry/actions/workflows/delete_package_dev.yml/dispatches' -d '{"ref": "main", "inputs": {"orgName": "bctestorg","packageName":"'$connectorName'","version":"0.1.0"}}'
          popd
        done

        popd
  stage-setup:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'stage' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: stage
      - name: Setup environments
        id: write
        run: |
          cd tests/integration_tests/test_packages
          tests=$(ls -d */ | cut -f1 -d'/' | jq -R -s -c 'split("\n")[:-1]')
          echo "::set-output name=test::${tests}"
    outputs:
      matrix: ${{ steps.write.outputs.test }}
  stage-push:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'stage' }}
    needs: stage-setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_name: ${{ fromJson(needs.stage-setup.outputs.matrix) }}
    env:
      TEST_NAME: "${{ matrix.test_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: stage
      - name: Build Package
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_packages/${{ matrix.test_name }}
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_STAGE_ACCESS_TOKEN }}
          BALLERINA_STAGE_CENTRAL: true
        with:
          args:
            pack
      - name: Push Package
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_packages/${{ matrix.test_name }}
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_STAGE_ACCESS_TOKEN }}
          BALLERINA_STAGE_CENTRAL: true
        with:
          args:
            push
  stage-test:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'stage' }}
    needs: stage-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: stage
      - name: Execute tests
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_suite
          BALLERINA_STAGE_CENTRAL: true
          API_URL : https://api.staging-central.ballerina.io
          DOCS_URL : https://staging-central.ballerina.io
        with:
          args:
            test
  stage-cleanup:
    if: ${{ github.event_name == 'schedule' || (github.event.inputs.environment == 'stage' && always()) }}
    needs: [stage-push,stage-test]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: stage
    - name: Cleanup Packages
      shell: bash
      run: |
        pushd tests/integration_tests/test_packages
          
        for d in */ ; do
          pushd $d
          connectorName="$d"
          curl -X POST -H "Accept: application/vnd.github.v3+json"  -H "authorization: Bearer ${{ secrets.PAT_TOKEN }}" 'https://api.github.com/repos/wso2-enterprise/ballerina-registry/actions/workflows/delete_package_staging.yml/dispatches' -d '{"ref": "main", "inputs": {"orgName": "bctestorg","packageName":"'$connectorName'","version":"0.1.0"}}'
          popd
        done

        popd
  prod-setup:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'prod' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: prod
      - name: Setup environments
        id: write
        run: |
          cd tests/integration_tests/test_packages
          tests=$(ls -d */ | cut -f1 -d'/' | jq -R -s -c 'split("\n")[:-1]')
          echo "::set-output name=test::${tests}"
    outputs:
      matrix: ${{ steps.write.outputs.test }}
  prod-push:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'prod' }}
    needs: prod-setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_name: ${{ fromJson(needs.prod-setup.outputs.matrix) }}
    env:
      TEST_NAME: "${{ matrix.test_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: prod
      - name: Build Package
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_packages/${{ matrix.test_name }}
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_ACCESS_TOKEN }}
        with:
          args:
            pack
      - name: Push Package
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_packages/${{ matrix.test_name }}
          BALLERINA_CENTRAL_ACCESS_TOKEN: ${{ secrets.BALLERINA_CENTRAL_ACCESS_TOKEN }}
        with:
          args:
            push
  prod-test:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.environment == 'prod' }}
    needs: prod-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: prod
      - name: Execute tests
        uses: ballerina-platform/ballerina-action@master
        env:
          WORKING_DIR: tests/integration_tests/test_suite
          API_URL : https://api.central.ballerina.io
          DOCS_URL : https://central.ballerina.io
        with:
          args:
            test
  prod-cleanup:
    if: ${{ github.event_name == 'schedule' || (github.event.inputs.environment == 'prod' && always()) }}
    needs: [prod-push,prod-test]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: prod
    - name: Cleanup Packages
      shell: bash
      run: |
        pushd tests/integration_tests/test_packages
          
        for d in */ ; do
          pushd $d
          connectorName="$d"
          curl -X POST -H "Accept: application/vnd.github.v3+json"  -H "authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" 'https://api.github.com/repos/wso2-enterprise/ballerina-registry/actions/workflows/delete_package_prod.yml/dispatches' -d '{"ref": "main", "inputs": {"orgName": "bctestorg","packageName":"'$connectorName'","version":"0.1.0"}}'
          popd
        done

        popd
